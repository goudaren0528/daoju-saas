文档记录
版本
时间
处理人
内容
1.0.0
7月29日
潘韵芝
- 道具saas功能1.0版本整理
1.0.1
8月4日
洪伟填
- 更新功能背景、目标、场景
- 删除活动系统功能
- 更新商户道具管理、玩家背包操作功能
- 更新业务主要流程图
1.0.2
8月6日
洪伟填
- 更新商户信息、操作
- 错误提示场景、数据合规
1.0.3
9月4日
洪伟填
- 后台/界面交互原型图
1.0.4
当前日期
系统架构师
- 新增商户-应用-模块三级架构设计
- 明确数据隔离机制和权限控制
- 更新应用管理和模块功能说明
1.0.5
当前日期
系统架构师
- 优化SaaS三层架构导航系统设计
- 明确化层级关系和视觉层次
- 完善应用切换器和面包屑导航方案
一、需求背景
- 原免费投注活动功能作为 GMP 游戏平台内的模块，主要服务于平台内商户与游戏推广。现基于业务拓展需求，为提升模块复用性并拓展平台能力，该功能现独立为道具 SaaS 服务。通过标准化、模块化的形式对外提供服务，验证 SaaS 模式可行性，并为构建SaaS 功能平台奠定基础。
- 合规性准备：为GMP业务的合规调整做准备，将游戏开发和平台服务陆续实现独立运作
二、需求目的
- 给客户提供道具管理/统计等能力，满足用户管理如免费投注道具等数据的需求，减少单独开发道具背包系统的时间成本。
  - 1.0版本：商户接入、道具模板增删改查、用户道具发放、用户道具消耗、核销统计记录等基础能力；提供统一接口，支持快速接入，预留扩展能力
  - 实现多租户模型，接入GMP作为第一个商户，完成1.0版本道具SaaS能力交付
三、功能应用场景
商户A想做一个免费抽奖次数活动，可以在道具SAAS平台创建一个名为“免费抽奖券”的道具，并设定图标、使用效果、有效期、库存等道具属性。
场景1：在A平台的用户达到指定条件时，A平台调用SAAS发放道具接口给指定用户发放“免费抽奖券”道具
场景2：在A平台的用户在平台内打开背包，A平台调用SAAS查询道具模板接口查询用户的“免费抽奖券”的道具种类、数量、有效期等信息
场景3：A平台发现平台活动服务有规则错误，要使所有某个已发放的道具不可用，可以通过SAAS的更新道具模板接口，更新道具的启动状态为禁用
场景4：在A平台的用户消耗“免费抽奖券”参与了活动时，商户A平台可调用SAAS修改用户道具接口，更新用户的道具持有数量
场景5：在A平台的用户反馈了道具使用数据有问题，可以通过SAAS查询用户道具记录接口获取某用户的道具流水用户信息核对
四、系统架构设计

（一）商户-应用-模块三级架构

道具SaaS平台采用三级架构设计，确保数据隔离和权限管理：

```
道具SaaS平台
├── 商户层（Merchant Level）
│   ├── 商户管理：商户注册、认证、状态管理
│   ├── 商户概览：商户维度的数据统计和监控
│   └── 商户权限：基于商户的访问控制
├── 应用层（Application Level）
│   ├── 应用管理：每个商户可创建多个应用
│   ├── 应用隔离：不同应用间数据完全隔离
│   └── 应用切换：支持在不同应用间切换操作
└── 模块层（Module Level）
    ├── 道具模板管理：在应用范围内管理道具模板
    ├── 用户背包系统：在应用范围内管理用户道具
    └── 数据统计功能：在应用范围内进行数据统计
```

（二）架构层级关系

1. **商户层**：
   - 每个商户拥有独立的merchant_id和secret
   - 商户间数据完全隔离，互不可见
   - 商户可以创建和管理多个应用

2. **应用层**：
   - 每个应用拥有独立的app_id
   - 同一商户下的不同应用数据隔离
   - 应用可以独立启用/禁用
   - 所有模块功能都在应用范围内操作

3. **模块层**：
   - 道具模板、用户背包、数据统计都属于特定应用
   - 跨应用的数据访问被严格禁止
   - 模块功能的权限控制基于应用级别

（三）数据隔离机制

- **商户级隔离**：通过merchant_id确保商户间数据隔离
- **应用级隔离**：通过app_id确保同一商户下不同应用的数据隔离
- **模块级隔离**：所有道具、背包、统计数据都关联到特定应用

（四）导航系统优化设计

**1. 层级关系明确化**：
- **顶层（顶部导航栏）**：
  * 商户信息展示作为系统最高层级标识
  * 应用切换器位于导航栏右侧区域，便于快速切换
  * 用户菜单和系统设置入口

- **中层（主侧边栏）**：
  * 商户管理作为超级管理员功能入口
  * 应用管理作为核心二级功能入口
  * 应用模块作为三级功能展开区域

- **底层（内容区导航）**：
  * 三级面包屑路径：商户 > 应用管理 > [具体应用模块]
  * 页面内二级导航和功能切换

**2. 视觉层级设计**：
- **渐变色背景**：不同层级使用不同色彩主题区分
- **缩进间距**：通过视觉缩进明确父子关系
- **选中状态**：当前路径高亮标识和激活状态

**3. 交互优化方案**：
- **主侧边栏常驻**：保持导航结构稳定性
- **动态内容加载**：根据选中应用动态展示相关模块
- **上下文感知**：应用切换后自动更新相关功能入口

五、概述
（一）SAAS交付模式
- 多租户公有云
（二）接入条件
- 客户在 SaaS 平台完成注册与认证，获取专属接入凭证（merchant_id和secret）
（三）业务范围划分
SAAS实现能力
商户实现能力
- 商户创建
- 应用-可用于子商户区分数据
- 道具模板创建、修改、删除、查询
- 道具模板用量库存统计
- 用户背包道具的发放、查询、删除、修改
- 用户道具流水记录
- 道具在商户应用内使用逻辑
- 道具在应用中的发放
- 道具在应用中的展示

（四）整体流程图
- 以主要的道具"创建-使用-记录"流程展示为主，以此了解SAAS平台与商户的业务协作流程，其他分支流程暂不显示
暂时无法在飞书文档外展示此内容
五、功能说明
SaaS 平台提供标准化接口，支持客户快速接入
商户管理
- 商户创建、更新等先通过程序脚本处理，支持创建、更新商户状态、重置密钥；
- 商户信息
参数名称
参数字段
参数类型
说明
限制
商户ID
merchant_id
string
商户唯一标识
- 数字字母，限制30字符
商户名称
merchant_name
string
商户名不可重复
- 数字字母，限制30字符
密钥
secret
string
首次创建商户后，需要点击重置生成

状态
status
int
状态:
1: 启用
2: 禁用，禁用状态下api都不可调用

应用管理
- 基于三级架构设计，应用层作为商户和模块之间的中间层，实现数据隔离和权限控制
- 同个商户可创建多个应用，每个应用拥有独立的数据空间，应用间数据完全隔离
- 所有道具模板、用户背包、数据统计功能都在应用范围内操作，确保数据安全
- 应用增改查，提供api能力
  - 创建：每个商户可以创建多个应用，不限制上限，每个应用自动分配唯一app_id
  - 删除：暂不提供删除应用的能力，避免数据丢失
  - 修改：只能修改应用的状态，启用/禁用。禁用状态下，应用相关的所有API都不可调用
  - 查询：查询当前商户已创建的应用列表信息，支持应用切换
- 应用上下文：前端界面需要先选择应用，所有后续操作都在选中应用的数据范围内进行
- 应用信息
参数名称
参数字段
参数类型
说明
限制
应用id
app_id
string
商户唯一标识

应用名
app_name
string
商户名不可重复
- 数字字母，限制30字符
状态
status
int
状态:
1: 启用，默认状态
2: 禁用，禁用状态下api都不可调用

模块层功能 - 道具模板管理

- 道具模板管理作为模块层的核心功能，所有道具都属于特定应用
- 道具的创建、修改、删除、查询都在应用范围内进行，跨应用访问被严格禁止
- 道具ID在应用范围内唯一，不同应用可以有相同的道具ID而不冲突

应用道具管理
（〇）道具参数
参数名称
参数字段
参数类型
必填
参数示例
说明
限制
道具类型
item_type
string
是
game_bet
- 商户自定义，如游戏投注类道具
- 数字字母，限制30字符
道具名称
item_name
string
是
免费投注次数
- 道具名称，支持重复
- 限制30字符
道具ID
item_id
string
是
freebet10001
- 道具唯一ID，同一应用下的ID不支持重复，不同应用可以有相同道具ID
- 数字字母，限制30字符
道具图标
item_icon
string
否
填图片地址

- 不填的话，使用默认图片地址：待提供
- 若填写的地址无法正常显示图片，也启用默认图片地址

道具参数
eff_arg
object
是
{"bet_amount":0.1,"max_payout":1000}
- 定义业务需要的道具参数，如配置限定投注的额度、最大返奖
- 限制200字符
状态
status

int
是
1，2，3
- 状态：
  - 1：启用，默认状态，仅该状态下道具正常可用
  - 2：禁用
  - 3：待删除
  - 4：过期
  - 5：已删除

动态过期时长

expire_duration

int
否

7

- 玩家获得该道具后，就根据所填时间开始倒计时，查询道具时，倒计时结束后道具状态更新为过期，不可用，api返回过期状态
- 时间单位为hour
- 不填视为无限制
- 正整数，限制30字符

固定过期时间
expire_date
datetime
否
格式为YYYY-MM-DDTHH:MM:SS, 时区为UTC0
- 查询道具时，道具达到这个时间，道具状态更新为过期，不可用，api返回过期状态
- 不填视为无限制
- 正整数，限制10字符
持有上限

limit_max

int
否
1

- 单个玩家可获得道具的最大数量
- 超过上限不再获得
- 不填视为无限制
- 正整数，限制30字符
每日发放上限

daily_limit_max
int
否
100000

- 该道具全局每日发放上限，超过配置值则当日不再发放
- 不填视为无限制
- 正整数，限制30字符
总发放上限
total_limit
int
否
100000
- 该道具的总量发放上限，超过配置值不再发放
- 不填视为无限制
- 正整数，限制30字符
自定义参数
custom
object
否
{"currency":all,"game_code":["10001", "10002"]}
- 支持业务传入额外的业务信息，如限定支持的币种/游戏
- 限制200字符
（一）创建道具模板
参数名称
必填
参数字段
参数类型
说明
商户ID
是
merchant_id
string
服务端提供
道具数据
是
item_data
array
[{object1},{object2}]
- 商户仅能为自己创建道具，支持创建多个道具
  - 创建道具需要包含所有道具参数中所有参数
  - 限制道具创建数量200
- 返回结果
  - 是否创建成功（失败需要错误码）
  - 处理时间
（二）查询道具模板
参数名称
必填
参数字段
参数类型
说明
商户ID
是
merchant_id
string
服务端提供，不存在时返回错误
应用ID
否
app_id
string
服务端提供，不存在时返回错误
道具ID
否
item_id
array
不存在时返回错误
- 支持查询完整列表和查询多个道具详情，返回每个道具所有的参数字段
  - 查询完整列表时通过商户ID
  - 查询应用关联列表时通过商户ID/应用
  - 查询单个道具详情时通过商户ID/应用/道具ID
- 返回结果
  - 是否创建成功（失败需要错误码）
  - 处理时间
  - 查询结果：返回每个道具所有的参数字段
（三）更新道具模板
参数名称
必填
参数字段
参数类型
说明
商户ID
是
merchant_id
string
服务端提供，不存在时返回错误
应用ID
否
app_id
string
服务端提供，不存在时返回错误
道具数据
是
item_data
array
参数字段不存在时返回错误
[{object1},{object2}]
- 通过调用更新道具接口，可以更新除商户ID/道具ID以外的道具参数
  - 可批量修改多个道具
  - 支持部分更新参数，道具数据未提供的字段视为不更新，item_data的对象必须包含item_id
  - 更新后，对所有同商户应用的同一道具id所有发放的数据生效（包括有效期计算）；在查询、消耗时需要根据新的道具参数生效
- 返回结果
  - 是否更新成功（失败需要错误码）
  - 处理时间

（四）删除道具模板
参数名称
必填
参数字段
参数类型
说明
商户ID
是
merchant_id
string
服务端提供，不存在时返回错误
应用ID
否
app_id
string
服务端提供，不存在时返回错误
道具ID
是
item_id
array
不存在时返回错误
- 通过调用删除道具接口，删除指定道具ID，可以一次删除多个，删除逻辑为软删除
  - 商户调用道具列表查询状态返回“待删除”；背包查询“待删除”道具ID返回“道具不存在”
  - 软删除道具7天后永久删除，道具列表查询不返回已删除道具；背包查询已删除道具ID返回“道具不存在”
  - 7天内用户可以通过更新道具参数修改道具状态为其他状态，视为恢复
- 返回结果
  - 是否删除成功（失败需要错误码）
  - 处理时间
（五）道具模板产耗统计
参数名称
必填
参数字段
参数类型
说明
商户ID

是
merchant_id
string
服务端提供，不存在时返回错误
应用ID
否
app_id
string
服务端提供，不存在时返回错误
道具ID
否
item_id
array
不存在时返回错误
- 提供道具ID参数，可以批量，查询指定道具ID当前的发放量、消耗量、剩余库存（无限量时返回-1）
- 只查询应用，则返回应用关联所有道具的产耗库存数据（数组）
- 返回结果
  - 是否删除成功（失败需要错误码）
  - 处理时间
  - 返回数据：数组，罗列每个道具ID的产耗数据
参数名称
参数字段
参数类型
说明
商户ID
merchant_id
string
服务端提供，不存在时返回错误
应用ID
app_id
string
服务端提供，不存在时返回错误
道具ID
item_id
array
不存在时返回错误
已发放量
distributed
int
0<=的整数
消耗量
usage
int
0<=的整数
库存
remaining
int
-1<=的整数，-1为无库存限制
模块层功能 - 用户背包系统

- 用户背包系统作为模块层功能，所有用户道具数据都属于特定应用
- 用户在不同应用中拥有独立的背包，应用间背包数据完全隔离
- 道具发放、查询、修改、消耗都在应用范围内进行

玩家背包操作
（〇）背包道具参数
参数名称
参数字段
参数类型
说明
商户ID
merchant_id
string
服务端提供，不存在时返回错误
应用ID
app_id
string
服务端提供，不存在时返回错误
道具ID
item_id
string
道具唯一标识
道具数量
amount
int
道具数量，正整数
道具过期时间
expire_time
datetime

格式为YYYY-MM-DDTHH:MM:SS, 时区为UTC0
- 道具模板，同时配置了expire_duration 与 expire_date，取两者更早者为实际过期 
道具获取时间
obtain_time
datetime
格式为YYYY-MM-DDTHH:MM:SS, 时区为UTC0
道具状态
status
int
1: 正常，2: 过期
（一）发放道具
- 可以对指定用户ID发放指定道具，在发放时需要提供发放的道具ID、发放数量、计算过期时间
- 返回结果：发放是否成功、发放时间
参数名称
参数字段
必填
参数类型
说明
商户ID
merchant_id
是
string
服务端提供，不存在时返回错误
应用ID
app_id
是
string
服务端提供，不存在时返回错误
用户ID
player_id
是
array
玩家唯一标识，支持批量处理
发放道具详情
items

是
array
- 格式：
[
  {
  "item_id":"freebet10001", 
  "amount":3, 
  "expire_time":"2025-06-27T10:00:00", 
  "obtain_time":"2025-06-20T10:00:00",
  "status":1
  },
  {
  ...
  }
]
- 道具模板，同时配置了expire_duration 与 expire_date，取两者更早者为实际过期 
备注
remark
否
string
- 用于说明发放事由，比如扣除超发道具等
（二）查询用户道具
- 商户通过玩家 ID 查询其持有的道具详情
  - 每次获取用户道具时，需要验证是否过期，更新道具状态
  - 返回道具每页上限200
- 返回结果：
  - 道具信息：返回持有数量、过期时间、获取时间、状态
  - 查询时间
参数名称
参数字段
必填
参数类型
说明
商户ID
merchant_id
是
string
服务端提供，不存在时返回错误
应用ID
app_id
是
string
服务端提供，不存在时返回错误
用户ID
player_id
是
string
玩家唯一标识
道具ID
item_id
是

array
道具ID
（三）修改用户道具
- 可以通过修改接口对指定用户的指定道具修改amount、expire_time参数值
  - 已过期道具，修改expire_time，状态不变
- 返回结果：
  - 是否修改成功
  - 查询时间
参数名称
参数字段
必填
参数类型
说明
商户ID
merchant_id
是
string
服务端提供，不存在时返回错误
应用ID
app_id
是
string
服务端提供，不存在时返回错误
用户ID
player_id
是
array
玩家唯一标识，支持批量处理
修改道具详情
items
是

array
- 持有道具列表，每项格式：
[
  {
  "item_id":"freebet10001", 
  "amount":3, 
  "expire_time":"2025-06-27T10:00:00", 
  "obtain_time":"2025-06-20T10:00:00"
  },
  {
  ...
  }
]
备注
remark
否
string
用于说明事由
（四）消耗用户道具
- 当玩家使用道具后，商户需实时向SaaS调用消耗用户道具接口
  - 判断请求参数是否有误
  - 判断用户是否有足够的道具数量可扣除，如无需返回错误；如有则返回使用结果，更新用户道具数据
- 返回结果：
  - 是否使用成功
  - 查询时间
参数名称
参数字段
必填
参数类型
说明
商户ID
merchant_id
是
string
服务端提供，不存在时返回错误
应用ID
app_id
是
string
服务端提供，不存在时返回错误
用户ID
player_id
是
array
玩家唯一标识，支持批量处理
道具ID
item_id

是

string
道具唯一标识
道具数量
amount
是
int
正整数，消耗数量
备注
remark
否
string
用于说明发放事由，比如扣除超发道具等
（五）查询用户道具记录
- 该接口亦可通过商户ID 、时间范围、玩家ID、道具ID 查询使用道具的用户道具记录（数据保存时长）
  - 不提供道具ID的时候，返回用户所有道具记录
  - 不提供道具ID的时候，返回所有道具记录
参数名称
参数字段
必填
参数类型
说明
商户ID
merchant_id
是
string
服务端提供，不存在时返回错误
应用ID
app_id
是
string
服务端提供，不存在时返回错误
开始时间
start_time
是
datetime
格式，2023-10-07T23:59:59
结束时间
end_time
是
datetime
格式，2023-10-07T23:59:59
用户ID
player_id
否
array
玩家唯一标识，支持批量处理
道具ID
item_id
否
string
道具唯一
- 返回结果：
  - 是否使用成功
  - 查询时间
  - 返回查询数据
参数名称
参数字段
参数类型
说明
商户ID
merchant_id
string
服务端提供，不存在时返回错误
应用ID
app_id
string
服务端提供，不存在时返回错误
流水ID
record_id
string
流水唯一ID
道具ID
item_id
array
不存在时返回错误
数量
amount
int
0<=的整数
备注
remark
string
发放、消耗、修改的事由信息
业务错误提示
A. 通用类
场景
触发条件示例
参数缺失/格式错误
必填字段为空、类型不符、非枚举值等
未经授权
认证头缺失或签名失效等
无访问权限
跨租户访问、环境不匹配等
服务端未知异常
程序错误等
C. 商户类
场景
触发条件示例
商户被禁用
商户状态 status = 2
D. 道具生命周期
场景
触发条件示例
道具不存在
道具ID错误、道具删除
道具已禁用
状态 = 禁用、待删除
道具已过期
当前时间 > 过期时间 expire_time
E. 发放流程
场景
触发条件示例
日限额用尽
daily_limit_max ≤ 0
总限额用尽
total_limit ≤ 0
玩家背包已满
玩家持有数量 ≥ limit_max
F. 背包查询 / 分页
场景
触发条件示例
分页过大
page_size > 分页返回上限200
G. 消耗流程
- 主要是一些并发和延迟场景
场景
触发条件示例
背包无道具
玩家被回收道具
数量不足
请求扣减量 > 当前持有量
并发冲突
多端同时消费同一件
H. 应用类
场景
触发条件示例
应用被禁用
应用状态 status = 2
D. 道具生命周期
数据合规
- 默认保存 180 天，商户可自定义时间范围： 30-365天
- 数据支持导出为csv/json，支持导出数据包括
  - 考虑数据过大可以做切分，如时间、商户维度
数据
字段
说明
道具表
道具表所有字段

用户背包流水
道具流水记录所有字段

审计日志（暂未提供）
后续补充
后续补充
